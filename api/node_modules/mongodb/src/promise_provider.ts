import { MongoInvalidArgumentError } from './error';

/** @internal */
const kPromise = Symbol('promise');

interface PromiseStore {
<<<<<<< HEAD
  [kPromise]?: PromiseConstructor;
}

const store: PromiseStore = {
  [kPromise]: undefined
=======
  [kPromise]: PromiseConstructor | null;
}

const store: PromiseStore = {
  [kPromise]: null
>>>>>>> 895f4278cd300f98295191297723a8c0711282fe
};

/**
 * Global promise store allowing user-provided promises
<<<<<<< HEAD
 * @public
 */
export class PromiseProvider {
  /** Validates the passed in promise library */
=======
 * @deprecated Setting a custom promise library is deprecated the next major version will use the global Promise constructor only.
 * @public
 */
export class PromiseProvider {
  /**
   * Validates the passed in promise library
   * @deprecated Setting a custom promise library is deprecated the next major version will use the global Promise constructor only.
   */
>>>>>>> 895f4278cd300f98295191297723a8c0711282fe
  static validate(lib: unknown): lib is PromiseConstructor {
    if (typeof lib !== 'function')
      throw new MongoInvalidArgumentError(`Promise must be a function, got ${lib}`);
    return !!lib;
  }

<<<<<<< HEAD
  /** Sets the promise library */
  static set(lib: PromiseConstructor): void {
=======
  /**
   * Sets the promise library
   * @deprecated Setting a custom promise library is deprecated the next major version will use the global Promise constructor only.
   */
  static set(lib: PromiseConstructor | null): void {
    // eslint-disable-next-line no-restricted-syntax
    if (lib === null) {
      // Check explicitly against null since `.set()` (no args) should fall through to validate
      store[kPromise] = null;
      return;
    }

>>>>>>> 895f4278cd300f98295191297723a8c0711282fe
    if (!PromiseProvider.validate(lib)) {
      // validate
      return;
    }
    store[kPromise] = lib;
  }

<<<<<<< HEAD
  /** Get the stored promise library, or resolves passed in */
  static get(): PromiseConstructor {
    return store[kPromise] as PromiseConstructor;
  }
}

PromiseProvider.set(global.Promise);
=======
  /**
   * Get the stored promise library, or resolves passed in
   * @deprecated Setting a custom promise library is deprecated the next major version will use the global Promise constructor only.
   */
  static get(): PromiseConstructor | null {
    return store[kPromise];
  }
}
>>>>>>> 895f4278cd300f98295191297723a8c0711282fe
